# å‰åç«¯å¯¹æ¥æŒ‡å—

## ğŸ¯ æ ¸å¿ƒè¯´æ˜

**æ‚¨çš„å‰ç«¯åªéœ€è¦å¯¹æ¥è¿™äº›æ–‡ä»¶ï¼š**
- âœ… **app.py** - æ­£å¼åç«¯APIæœåŠ¡å™¨ï¼ˆé›†æˆäº†æ‰€æœ‰åŠŸèƒ½ï¼‰
- âœ… **analysis_service.py** - AIåˆ†ææœåŠ¡ï¼ˆå·²é›†æˆåˆ°app.pyä¸­ï¼‰
- âœ… **dao.py/models.py** - æ•°æ®åº“æ“ä½œ

**ä¸éœ€è¦è¿™äº›æµ‹è¯•æ–‡ä»¶ï¼š**
- âŒ simple_chess_teaching.pyï¼ˆä»…ç”¨äºæœ¬åœ°æµ‹è¯•æ¼”ç¤ºï¼‰
- âŒ simple_*.py ç³»åˆ—æ–‡ä»¶ï¼ˆéƒ½æ˜¯ç®€åŒ–æµ‹è¯•å·¥å…·ï¼‰
- âŒ chess_game_test.pyï¼ˆåç«¯æµ‹è¯•è„šæœ¬ï¼‰
- âŒ test_end.pyï¼ˆç«¯åˆ°ç«¯æµ‹è¯•è„šæœ¬ï¼‰

---

## ğŸ”§ å¯åŠ¨åç«¯æœåŠ¡

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ
python app.py
# æˆ–
python run_server.py
```

åç«¯å°†åœ¨ http://localhost:8000 å¯åŠ¨ï¼ˆé»˜è®¤ç«¯å£å·²æ”¹ä¸º8000ï¼‰

---

## ğŸ“¡ APIç«¯ç‚¹è¯´æ˜

### ğŸ” ç”¨æˆ·è®¤è¯API

#### ç”¨æˆ·æ³¨å†Œ
```
POST /api/auth/register
Content-Type: application/json

Body:
{
    "username": "test_user",
    "password": "password123"
}

Response:
{
    "success": true,
    "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "user": {
        "id": 1,
        "username": "test_user"
    }
}
```

#### ç”¨æˆ·ç™»å½•
```
POST /api/auth/login
Content-Type: application/json

Body:
{
    "username": "test_user",
    "password": "password123"
}

Response:
{
    "success": true,
    "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "user": {
        "id": 1,
        "username": "test_user"
    }
}
```

### ğŸ“Š ç”¨æˆ·æ•°æ®API

#### è·å–ç”¨æˆ·èµ„æ–™
```
GET /api/user/profile
Authorization: Bearer <token>

Response:
{
    "success": true,
    "user": {
        "id": 1,
        "username": "test_user",
        "createdAt": "2025-07-14T10:00:00Z"
    },
    "stats": {
        "totalGames": 25,
        "wins": 18,
        "losses": 5,
        "draws": 2,
        "winRate": 0.72,
        "eloRating": 1450
    }
}
```

#### è·å–å†å²å¯¹å±€
```
GET /api/user/history?limit=10
Authorization: Bearer <token>

Response:
{
    "success": true,
    "games": [
        {
            "gameId": "123",
            "opponent": "AI",
            "result": "win",        // win/loss/draw
            "userColor": "white",
            "moveCount": 45,
            "date": "2025-07-14T10:30:00Z",
            "difficulty": "medium"
        }
    ],
    "total": 25,
    "page": 1,
    "limit": 10
}
```

#### è·å–å•å±€è¯¦æƒ…
```
GET /api/user/history/<game_id>
Authorization: Bearer <token>

Response:
{
    "success": true,
    "game": {
        "gameId": "123",
        "moves": ["e2e4", "e7e5", "g1f3", "b8c6"],
        "boardStates": ["rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1", ...],
        "result": "win",
        "duration": "00:15:30"
    }
}
```

#### è·å–æ’è¡Œæ¦œ
```
GET /api/users/ranking?limit=10
Authorization: Bearer <token>

Response:
{
    "success": true,
    "users": [
        {
            "rank": 1,
            "username": "master_player",
            "elo_rating": 1800,
            "total_games": 150,
            "winning_rate": 85.2
        },
        {
            "rank": 2,
            "username": "test_user",
            "elo_rating": 1450,
            "total_games": 25,
            "winning_rate": 72.0
        }
    ]
}
```

### ğŸ“ æ•™å­¦æ¨¡å¼APIï¼ˆæ¯æ­¥AIåˆ†æï¼‰

#### å¼€å§‹æ•™å­¦æ¸¸æˆ
```
POST /api/teaching/start
Content-Type: application/json
Authorization: Bearer <token>

Body:
{
    "lesson_type": "general",  // general/opening/endgame
    "color": "white"           // white/black
}

Response:
{
    "success": true,
    "gameId": "teaching_1_1721785234.56",
    "boardState": "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",
    "userColor": "white",
    "lessonType": "general",
    "instructions": "æ¬¢è¿è¿›å…¥æ•™å­¦æ¨¡å¼ï¼æ¯èµ°ä¸€æ­¥éƒ½ä¼šå¾—åˆ°AIåˆ†æå’ŒæŒ‡å¯¼ã€‚"
}
```

#### æ•™å­¦æ¨¡å¼èµ°æ£‹ï¼ˆæ ¸å¿ƒAPIï¼‰
```
POST /api/teaching/<game_id>/move
Content-Type: application/json
Authorization: Bearer <token>

Body:
{
    "move": "e2e4"  // æ ‡å‡†UCIæ ¼å¼: e2e4, g1f3, a7a8q(å‡å˜)
}

Response:
{
    "success": true,
    "userMove": "e2e4",
    "userAnalysis": "è¿™æ˜¯ä¸€ä¸ªexcellentçš„å¼€å±€èµ°æ³•ã€‚ä¼˜ç‚¹ï¼šæ§åˆ¶ä¸­å¿ƒe5æ ¼...",
    "moveQuality": "excellent",  // excellent/good/questionable/unknown
    "aiMove": "e7e5",
    "aiAnalysis": "AIé€‰æ‹©å¯¹ç§°å›åº”ï¼Œè¿™æ˜¯æœ€ç»å…¸çš„å¼€å±€åº”å¯¹æ–¹å¼...",
    "currentFen": "rnbqkbnr/pppp1ppp/8/4p3/4P3/8/PPPP1PPP/RNBQKBNR w KQkq e6 0 2",
    "moveNumber": 1,
    "gameStatus": "ongoing"  // ongoing/finished
}
```

#### è·å–æ•™å­¦å†å²
```
GET /api/teaching/<game_id>/history
Authorization: Bearer <token>

Response:
{
    "success": true,
    "gameId": "teaching_1_1721785234.56",
    "moves": [
        {
            "move_number": 1,
            "move": "e2e4",
            "color": "white",
            "analysis": {
                "ai_analysis": "è¿™æ˜¯ä¸€ä¸ªexcellentçš„å¼€å±€èµ°æ³•...",
                "move_quality": "excellent"
            },
            "timestamp": "2025-07-14T10:30:00"
        }
    ],
    "currentTurn": "white",
    "gameStatus": "ongoing"
}
```

### ğŸ® æ™®é€šå¯¹å¼ˆAPIï¼ˆæ— é€æ­¥åˆ†æï¼‰

#### å¼€å§‹æ™®é€šæ¸¸æˆ
```
POST /api/game/match
Content-Type: application/json
Authorization: Bearer <token>

Body:
{
    "color": "white",        // white/black
    "difficulty": "medium"   // easy/medium/hard
}

Response:
{
    "gameId": "123",
    "userColor": "white",
    "currentPlayer": "white",
    "difficulty": "medium",
    "initialBoard": "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"
}
```

#### æ™®é€šå¯¹å¼ˆèµ°æ£‹
```
POST /api/game/<game_id>/move
Content-Type: application/json
Authorization: Bearer <token>

Body:
{
    "move": "e2e4"  // UCIæ ¼å¼
}

Response:
{
    "userMove": "e2e4",
    "aiMove": "e7e5",
    "result": "ongoing",        // ongoing/win/loss/draw
    "boardState": "rnbqkbnr/pppp1ppp/8/4p3/4P3/8/PPPP1PPP/RNBQKBNR w KQkq e6 0 2",
    "moveCount": 2,
    "isCheck": false,
    "isCheckmate": false,
    "capturedPiece": null
    
    // âŒ æ³¨æ„ï¼šæ™®é€šæ¨¡å¼æ²¡æœ‰ userAnalysis/aiAnalysis å­—æ®µ
    // ä¸“æ³¨äºå¿«é€Ÿå¯¹å¼ˆä½“éªŒï¼Œæ— AIåˆ†æåŠŸèƒ½
}
```

#### è·å–æ¸¸æˆçŠ¶æ€
```
GET /api/game/<game_id>
Authorization: Bearer <token>

Response:
{
    "gameId": "123",
    "status": "ongoing",
    "userColor": "white",
    "currentPlayer": "black",
    "boardState": "rnbqkbnr/pppp1ppp/8/4p3/4P3/8/PPPP1PPP/RNBQKBNR w KQkq e6 0 2",
    "moveHistory": ["e2e4", "e7e5"],
    "moveCount": 2
}
```

---

## ğŸ’» å‰ç«¯å®ç°ç¤ºä¾‹ï¼ˆJavaScriptï¼‰

```javascript
class ChessAPI {
    constructor(baseURL = 'http://localhost:8000') {  // æ³¨æ„ç«¯å£æ”¹ä¸º8000
        this.baseURL = baseURL;
        this.token = localStorage.getItem('chess_token');
    }

    // ğŸ” ç”¨æˆ·è®¤è¯
    async login(username, password) {
        const response = await fetch(`${this.baseURL}/api/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        if (data.token) {
            this.token = data.token;
            localStorage.setItem('chess_token', this.token);
        }
        return data;
    }

    async register(username, password) {
        const response = await fetch(`${this.baseURL}/api/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        if (data.token) {
            this.token = data.token;
            localStorage.setItem('chess_token', this.token);
        }
        return data;
    }

    // ï¿½ æ•™å­¦æ¨¡å¼æ ¸å¿ƒæ–¹æ³•
    async startTeachingGame(lessonType = 'general', color = 'white') {
        const response = await fetch(`${this.baseURL}/api/teaching/start`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.token}`
            },
            body: JSON.stringify({ lesson_type: lessonType, color })
        });
        
        return await response.json();
    }

    async makeTeachingMove(gameId, move) {
        const response = await fetch(`${this.baseURL}/api/teaching/${gameId}/move`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.token}`
            },
            body: JSON.stringify({ move })
        });
        
        const data = await response.json();
        
        // ğŸ¯ æ•™å­¦æ¨¡å¼ç‰¹è‰²ï¼šæ¯æ­¥éƒ½æœ‰è¯¦ç»†AIåˆ†æ
        if (data.success && data.userAnalysis) {
            this.displayTeachingAnalysis(data);
        }
        
        return data;
    }

    // ğŸ® æ™®é€šå¯¹å¼ˆæ–¹æ³•
    async startNormalGame(color = 'white', difficulty = 'medium') {
        const response = await fetch(`${this.baseURL}/api/game/match`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.token}`
            },
            body: JSON.stringify({ color, difficulty })
        });
        
        return await response.json();
    }

    async makeNormalMove(gameId, move) {
        const response = await fetch(`${this.baseURL}/api/game/${gameId}/move`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.token}`
            },
            body: JSON.stringify({ move })
        });
        
        return await response.json();
    }

    // ğŸ“Š ç”¨æˆ·æ•°æ®æ–¹æ³•
    async getUserProfile() {
        const response = await fetch(`${this.baseURL}/api/user/profile`, {
            headers: { 'Authorization': `Bearer ${this.token}` }
        });
        return await response.json();
    }

    async getUserHistory(limit = 10) {
        const response = await fetch(`${this.baseURL}/api/user/history?limit=${limit}`, {
            headers: { 'Authorization': `Bearer ${this.token}` }
        });
        return await response.json();
    }

    async getRanking(limit = 10) {
        const response = await fetch(`${this.baseURL}/api/users/ranking?limit=${limit}`, {
            headers: { 'Authorization': `Bearer ${this.token}` }
        });
        return await response.json();
    }

    // ğŸ“ æ•™å­¦åˆ†æUIæ˜¾ç¤ºæ–¹æ³•
    displayTeachingAnalysis(data) {
        console.log('=== AIæ•™å­¦åˆ†æ ===');
        console.log(`èµ°æ³•è´¨é‡: ${data.moveQuality}`);
        console.log(`ç”¨æˆ·åˆ†æ: ${data.userAnalysis}`);
        if (data.aiMove) {
            console.log(`AIåº”å¯¹: ${data.aiMove}`);
            console.log(`AIåˆ†æ: ${data.aiAnalysis}`);
        }
        console.log('==================');
        
        // åœ¨UIä¸­å±•ç¤ºåˆ†æç»“æœ
        this.updateAnalysisUI(data);
    }

    updateAnalysisUI(data) {
        // å®é™…é¡¹ç›®ä¸­åœ¨è¿™é‡Œæ›´æ–°DOMå…ƒç´ 
        // ä¾‹å¦‚æ˜¾ç¤ºèµ°æ³•è´¨é‡ã€åˆ†ææ–‡æœ¬ã€å»ºè®®ç­‰
    }
}

// ğŸ“– å®Œæ•´ä½¿ç”¨ç¤ºä¾‹
async function main() {
    const api = new ChessAPI();
    
    // 1. ç”¨æˆ·è®¤è¯
    try {
        await api.login('test_user', 'password123');
        console.log('ç™»å½•æˆåŠŸ');
    } catch (error) {
        await api.register('test_user', 'password123');
        console.log('æ³¨å†Œå¹¶ç™»å½•æˆåŠŸ');
    }
    
    // 2. æ•™å­¦æ¨¡å¼æ¸¸æˆï¼ˆé‡ç‚¹åŠŸèƒ½ï¼‰
    const teachingGame = await api.startTeachingGame('general', 'white');
    const gameId = teachingGame.gameId;
    
    // èµ°å‡ æ­¥æ£‹ï¼Œæ¯æ­¥éƒ½ä¼šå¾—åˆ°AIåˆ†æ
    const moves = ['e2e4', 'g1f3', 'f1c4'];
    for (const move of moves) {
        const result = await api.makeTeachingMove(gameId, move);
        console.log(`èµ°æ³• ${move} å®Œæˆï¼Œåˆ†æè´¨é‡: ${result.moveQuality}`);
        
        // åœ¨å®é™…UIä¸­æ˜¾ç¤ºè¯¦ç»†åˆ†æ
        // result.userAnalysis åŒ…å«å®Œæ•´çš„AIæ•™å­¦åˆ†æ
        // result.aiAnalysis åŒ…å«AIèµ°æ³•çš„è§£é‡Š
    }
    
    // 3. æ™®é€šå¯¹å¼ˆæ¨¡å¼
    const normalGame = await api.startNormalGame('white', 'medium');
    await api.makeNormalMove(normalGame.gameId, 'e2e4');
    
    // 4. æŸ¥çœ‹ç”¨æˆ·æ•°æ®
    const profile = await api.getUserProfile();
    const history = await api.getUserHistory(5);
    const ranking = await api.getRanking(10);
}
```

---

## ğŸ” å…³é”®åŒºåˆ«æ€»ç»“

| åŠŸèƒ½ç‰¹æ€§ | æ•™å­¦æ¨¡å¼ API | æ™®é€šå¯¹å¼ˆ API |
|----------|-------------|------------|
| **APIç«¯ç‚¹** | `/api/teaching/*` | `/api/game/*` |
| **æ ¸å¿ƒåŠŸèƒ½** | âœ… æ¯æ­¥AIåˆ†ææ•™å­¦ | âŒ æ— åˆ†æï¼Œå¿«é€Ÿå¯¹å¼ˆ |
| **å“åº”å­—æ®µ** | `userAnalysis`, `aiAnalysis`, `moveQuality` | åªæœ‰åŸºæœ¬æ¸¸æˆä¿¡æ¯ |
| **é€‚ç”¨åœºæ™¯** | ğŸ“ å­¦ä¹ æå‡ï¼ŒæŠ€èƒ½åŸ¹è®­ | ğŸ® å¨±ä¹å¯¹å¼ˆï¼Œå¿«é€Ÿæ¸¸æˆ |
| **æ€§èƒ½å½±å“** | è¾ƒæ…¢ï¼ˆéœ€AIåˆ†æï¼‰ | å¿«é€Ÿï¼ˆæ— åˆ†æå¼€é”€ï¼‰ |

## ğŸ¯ æ ¸å¿ƒé›†æˆè¦ç‚¹

### âœ… æ•™å­¦æ¨¡å¼é›†æˆè¦ç‚¹
```javascript
// 1. æ¯æ­¥èµ°æ³•éƒ½ä¼šè¿”å›è¯¦ç»†AIåˆ†æ
const result = await api.makeTeachingMove(gameId, 'e2e4');

// 2. é‡ç‚¹å¤„ç†è¿™äº›è¿”å›å­—æ®µ
console.log('AIåˆ†æ:', result.userAnalysis);    // ç”¨æˆ·èµ°æ³•çš„è¯¦ç»†åˆ†æ
console.log('èµ°æ³•è´¨é‡:', result.moveQuality);    // excellent/good/questionable
console.log('AIè§£é‡Š:', result.aiAnalysis);      // AIèµ°æ³•çš„æ•™å­¦è¯´æ˜

// 3. åœ¨UIä¸­çªå‡ºæ˜¾ç¤ºåˆ†æå†…å®¹
displayAnalysisPanel(result.userAnalysis);
showMoveQuality(result.moveQuality);
```

### âœ… æ™®é€šå¯¹å¼ˆé›†æˆè¦ç‚¹
```javascript
// 1. ä¸“æ³¨æ¸¸æˆæµç¨‹ï¼Œæ— åˆ†æå¼€é”€
const result = await api.makeNormalMove(gameId, 'e2e4');

// 2. å¤„ç†åŸºæœ¬æ¸¸æˆä¿¡æ¯
console.log('ç”¨æˆ·èµ°æ³•:', result.userMove);
console.log('AIåº”å¯¹:', result.aiMove);
console.log('æ¸¸æˆçŠ¶æ€:', result.result);

// 3. å¿«é€Ÿæ›´æ–°æ£‹ç›˜UI
updateChessBoard(result.boardState);
checkGameEnd(result.result);
```

### ğŸš€ æ¨èé›†æˆé¡ºåº

1. **ä¼˜å…ˆé›†æˆç”¨æˆ·è®¤è¯** - åŸºç¡€åŠŸèƒ½ï¼Œæ‰€æœ‰APIéƒ½éœ€è¦
2. **å…ˆåšæ™®é€šå¯¹å¼ˆ** - ç›¸å¯¹ç®€å•ï¼ŒéªŒè¯åŸºæœ¬æµç¨‹
3. **å†åšæ•™å­¦æ¨¡å¼** - æ ¸å¿ƒåŠŸèƒ½ï¼Œéœ€è¦é‡ç‚¹è®¾è®¡åˆ†æUI
4. **æœ€åæ·»åŠ ç”¨æˆ·æ•°æ®** - å¢å¼ºç”¨æˆ·ä½“éªŒ

### âš ï¸ å¸¸è§æ³¨æ„äº‹é¡¹

- **ç«¯å£å·**: åç«¯é»˜è®¤è¿è¡Œåœ¨ `:8000`ï¼Œä¸æ˜¯ `:5000`
- **èµ°æ³•æ ¼å¼**: ä½¿ç”¨UCIæ ¼å¼ (e2e4)ï¼Œä¸æ˜¯æ ‡å‡†ä»£æ•°è®°å· (e4)
- **Tokenè®¤è¯**: æ‰€æœ‰æ¸¸æˆAPIéƒ½éœ€è¦ `Authorization: Bearer <token>`
- **æ•™å­¦åˆ†æ**: `userAnalysis` å­—æ®µå¯èƒ½å¾ˆé•¿ï¼Œéœ€è¦é€‚å½“çš„UIå¸ƒå±€
- **é”™è¯¯å¤„ç†**: APIå¯èƒ½è¿”å›å„ç§é”™è¯¯ç ï¼Œéœ€è¦é€‚å½“å¤„ç†

---

## âœ… æ€»ç»“

1. **å‰ç«¯åªéœ€è¦å¯¹æ¥ app.py çš„APIï¼Œæ— éœ€å…¶ä»–æ–‡ä»¶**
2. **`analysis_service.py` å·²å®Œå…¨é›†æˆåˆ° `app.py` ä¸­**
3. **æ•™å­¦æ¨¡å¼æ˜¯æ ¸å¿ƒäº®ç‚¹ï¼Œæ¯æ­¥éƒ½æœ‰AIåˆ†æ**
4. **æ™®é€šå¯¹å¼ˆæ³¨é‡æ€§èƒ½ï¼Œæ— é€æ­¥åˆ†æ**
5. **æ‰€æœ‰åŠŸèƒ½å·²åœ¨åç«¯å®ç°ï¼Œå‰ç«¯ä¸“æ³¨UIå‘ˆç°**

ğŸ“š **å»ºè®®**: å‚è€ƒ `test_end.py` äº†è§£å®Œæ•´çš„APIè°ƒç”¨æµç¨‹å’Œé”™è¯¯å¤„ç†æ–¹å¼ã€‚
